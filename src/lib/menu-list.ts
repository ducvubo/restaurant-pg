import { permissions } from '@/app/dashboard/policy/policy';
import { Module } from '@/app/dashboard/policy/policy.interface';
import {
  Tag,
  Users,
  Settings,
  Bookmark,
  SquarePen,
  LayoutGrid,
  LucideIcon,
  Salad,
  HandPlatter,
  ListOrdered,
  TicketCheck,
  StickyNote,
  Album,
  EthernetPort,
} from 'lucide-react';

type Submenu = {
  href: string;
  label: string;
  active: boolean;
  key: string; // Added key
};

type Menu = {
  href: string;
  label: string;
  active: boolean;
  icon: LucideIcon;
  submenus: Submenu[];
  key: string; // Added key
};

type Group = {
  groupLabel: string;
  menus: Menu[];
};

const hasPermissionForPath = (
  path: string,
  key: string,
  poly_key: string[],
  permissions: Module[]
): boolean => {
  // Check key directly in poly_key
  if (poly_key.includes(key)) {
    console.log(`üöÄ ~ hasPermissionForPath ~ Key match: ${key} for ${path}`);
    return true;
  }

  // Remove query parameters from path for comparison
  const cleanPath = path.split('?')[0];
  for (const module of permissions) {
    // Check module key
    if (module.key === key && poly_key.includes(module.key)) {
      console.log(`üöÄ ~ hasPermissionForPath ~ Module key match: ${module.key} for ${cleanPath}`);
      return true;
    }
    for (const func of module.functions) {
      // Check function key
      if (func.key === key && poly_key.includes(func.key)) {
        console.log(`üöÄ ~ hasPermissionForPath ~ Function key match: ${func.key} for ${cleanPath}`);
        return true;
      }
      // Check action-specific permissions
      for (const action of func.actions) {
        if (
          action.patchRequire.some((p) => cleanPath.startsWith(p)) &&
          poly_key.includes(action.key)
        ) {
          console.log(`üöÄ ~ hasPermissionForPath ~ Action match: ${action.key} for ${cleanPath}`);
          return true;
        }
      }
    }
  }
  console.log(`üöÄ ~ hasPermissionForPath ~ No match for ${cleanPath} with key ${key}`);
  return false;
};

const baseMenuList = (pathname: string): Group[] => {
  return [
    {
      groupLabel: 'Qu·∫£n l√Ω',
      menus: [
        {
          href: '/dashboard/order',
          label: 'ƒê∆°n ƒë·∫∑t h√†ng',
          active: pathname.includes('/order'),
          icon: ListOrdered,
          key: 'order', // Matches module.key
          submenus: [
            {
              href: '/dashboard/order/dish',
              label: 'Danh s√°ch ƒë∆°n ƒë·∫∑t h√†ng',
              active: pathname === '/dashboard/order/dish',
              key: 'order_dish', // Matches function.key
            },
            {
              href: '/dashboard/order/table',
              label: 'ƒê∆°n ƒë·∫∑t theo b√†n',
              active: pathname === '/dashboard/order/table',
              key: 'order_table',
            },
            {
              href: '/dashboard/book-table',
              label: 'Danh s√°ch ƒë·∫∑t b√†n',
              active: pathname === '/dashboard/book-table',
              key: 'book_table',
            },
            {
              href: '/dashboard/order-food',
              label: 'Danh s√°ch ƒë·∫∑t m√≥n ƒÉn',
              active: pathname === '/dashboard/order-food',
              key: 'order_food',
            },
            {
              href: '/dashboard/order-combo',
              label: 'Danh s√°ch ƒë·∫∑t combo',
              active: pathname === '/dashboard/order-combo',
              key: 'order_combo',
            },
            {
              href: '/dashboard/book-room',
              label: 'Danh s√°ch ƒë·∫∑t ph√≤ng',
              active: pathname === '/dashboard/book-room',
              key: 'book_room',
            },
          ],
        },
        {
          href: '/dashboard/ticket-guest',
          label: 'Qu·∫£n l√Ω h·ªó tr·ª£',
          active: pathname.includes('/ticket-guest'),
          icon: TicketCheck,
          key: 'ticket_guest',
          submenus: [
            {
              href: '/dashboard/ticket-guest',
              label: 'Danh s√°ch h·ªèi ƒë√°p',
              active: pathname === '/dashboard/ticket-guest',
              key: 'ticket_list',
            },
            {
              href: '/dashboard/connect',
              label: 'Tin nh·∫Øn kh√°ch h√†ng',
              active: pathname === '/dashboard/connect',
              key: 'ticket_connect',
            },
            {
              href: '/dashboard/chat-bot',
              label: 'Chat bot kh√°ch h√†ng',
              active: pathname === '/dashboard/chat-bot',
              key: 'chat_bot',
            },
          ],
        },
        {
          href: '/dashboard/rooms',
          label: 'Qu·∫£n l√Ω ph√≤ng/s·∫£nh',
          active: pathname.includes('/rooms'),
          icon: Album,
          key: 'rooms',
          submenus: [
            {
              href: '/dashboard/rooms',
              label: 'Qu·∫£n l√Ω ph√≤ng/s·∫£nh',
              active: pathname === '/dashboard/rooms',
              key: 'room_list',
            },
            {
              href: '/dashboard/amenities',
              label: 'Qu·∫£n l√Ω d·ªãch v·ª•',
              active: pathname === '/dashboard/amenities',
              key: 'amenities',
            },
            {
              href: '/dashboard/menu-items',
              label: 'Qu·∫£n l√Ω th·ª±c ƒë∆°n',
              active: pathname === '/dashboard/menu-items',
              key: 'menu_items',
            },
          ],
        },
        {
          href: '/dashboard/employees',
          label: 'Qu·∫£n l√Ω nh√¢n vi√™n',
          active: pathname.includes('/employees'),
          icon: SquarePen,
          key: 'employees',
          submenus: [
            {
              href: '/dashboard/employees?page=1&size=10',
              label: 'Qu·∫£n l√Ω nh√¢n vi√™n',
              active: pathname === '/dashboard/employees',
              key: 'employee_list',
            },
            {
              href: '/dashboard/labels?page=1&size=10',
              label: 'Qu·∫£n l√Ω nh√£n',
              active: pathname === '/dashboard/labels',
              key: 'label',
            },
            {
              href: '/dashboard/working-shifts?page=1&size=10',
              label: 'Qu·∫£n l√Ω ca l√†m vi·ªác',
              active: pathname === '/dashboard/working-shifts',
              key: 'working_shift',
            },
            {
              href: '/dashboard/work-schedules',
              label: 'Qu·∫£n l√Ω l·ªãch l√†m vi·ªác',
              active: pathname === '/dashboard/work-schedules',
              key: 'work_schedule',
            },
            {
              href: '/dashboard/leave-application',
              label: 'Qu·∫£n l√Ω ƒë∆°n xin ngh·ªâ ph√©p',
              active: pathname === '/dashboard/leave-application',
              key: 'leave_application',
            },
          ],
        },
        {
          href: '/dashboard/tables',
          label: 'B√†n ƒÉn',
          active: pathname.includes('/tables'),
          icon: Bookmark,
          key: 'tables',
          submenus: [
            {
              href: '/dashboard/tables',
              label: 'Qu·∫£n l√Ω b√†n ƒÉn',
              active: pathname === '/dashboard/tables',
              key: 'table_list',
            },
          ],
        },
        {
          href: '/dashboard/dishes',
          label: 'M√≥n ƒÉn',
          active: pathname.includes('/dishes'),
          icon: Salad,
          key: 'dishes',
          submenus: [
            {
              href: '/dashboard/dishes',
              label: 'Qu·∫£n l√Ω m√≥n ƒÉn',
              active: pathname === '/dashboard/dishes',
              key: 'dish_list',
            },
            {
              href: '/dashboard/foods',
              label: 'Qu·∫£n l√Ω m√≥n ƒÉn online',
              active: pathname === '/dashboard/foods',
              key: 'online_dish',
            },
            {
              href: '/dashboard/food-combos',
              label: 'Qu·∫£n l√Ω combo m√≥n ƒÉn',
              active: pathname === '/dashboard/food-combos',
              key: 'food_combo',
            },
            {
              href: '/dashboard/special-offers',
              label: 'Qu·∫£n l√Ω ∆∞u ƒë√£i',
              active: pathname === '/dashboard/special-offers',
              key: 'special_offer',
            },
          ],
        },
        {
          href: '/dashboard/guest',
          label: 'Kh√°ch h√†ng',
          active: pathname.includes('/guest'),
          icon: Users,
          key: 'guest',
          submenus: [
            {
              href: '/dashboard/guest',
              label: 'Danh s√°ch kh√°ch h√†ng',
              active: pathname === '/dashboard/guest',
              key: 'guest_list',
            },
          ],
        },
        {
          href: '/dashboard/blogs',
          label: 'Blog',
          active: pathname.includes('/blogs'),
          icon: StickyNote,
          key: 'blog',
          submenus: [
            {
              href: '/dashboard/category-blog',
              label: 'Danh m·ª•c blog',
              active: pathname === '/dashboard/category-blog',
              key: 'category_blog',
            },
            {
              href: '/dashboard/article',
              label: 'B√†i vi·∫øt',
              active: pathname === '/dashboard/article',
              key: 'article',
            },
          ],
        },
        {
          href: '/dashboard/warehouse',
          label: 'Qu·∫£n l√Ω kho',
          active: pathname.includes('/warehouse'),
          icon: LayoutGrid,
          key: 'warehouse',
          submenus: [
            {
              href: '/dashboard/suppliers',
              label: 'Nh√† cung c·∫•p',
              active: pathname === '/dashboard/suppliers',
              key: 'supplier',
            },
            {
              href: '/dashboard/cat-ingredients',
              label: 'Danh m·ª•c nguy√™n li·ªáu',
              active: pathname === '/dashboard/cat-ingredients',
              key: 'cat_ingredient',
            },
            {
              href: '/dashboard/units',
              label: 'ƒê∆°n v·ªã ƒëo',
              active: pathname === '/dashboard/units',
              key: 'unit',
            },
            {
              href: '/dashboard/ingredients',
              label: 'Nguy√™n li·ªáu',
              active: pathname === '/dashboard/ingredients',
              key: 'ingredient',
            },
            {
              href: '/dashboard/stock-in',
              label: 'Nh·∫≠p kho',
              active: pathname === '/dashboard/stock-in',
              key: 'stock_in',
            },
            {
              href: '/dashboard/stock-out',
              label: 'Xu·∫•t kho',
              active: pathname === '/dashboard/stock-out',
              key: 'stock_out',
            },
          ],
        },
        {
          href: '/dashboard/other',
          label: 'Qu·∫£n l√Ω n·ªôi b·ªô',
          active: pathname.includes('/other'),
          icon: EthernetPort,
          key: 'internal',
          submenus: [
            {
              href: '/dashboard/internal-note',
              label: 'Qu·∫£n l√Ω ghi ch√∫',
              active: pathname === '/dashboard/internal-note',
              key: 'internal_note',
            },
            {
              href: '/dashboard/internal-proposal',
              label: 'Qu·∫£n l√Ω ƒë·ªÅ xu·∫•t',
              active: pathname === '/dashboard/internal-proposal',
              key: 'internal_proposal',
            },
            {
              href: '/dashboard/equipment-maintenance',
              label: 'Qu·∫£n l√Ω b·∫£o tr√¨ thi·∫øt b·ªã',
              active: pathname === '/dashboard/equipment-maintenance',
              key: 'equipment_maintenance',
            },
            {
              href: '/dashboard/operation-manual',
              label: 'Qu·∫£n l√Ω t√†i li·ªáu v·∫≠n h√†nh',
              active: pathname === '/dashboard/operation-manual',
              key: 'operation_manual',
            },
            {
              href: '/dashboard/operational-costs',
              label: 'Qu·∫£n l√Ω chi ph√≠ v·∫≠n h√†nh',
              active: pathname === '/dashboard/operational-costs',
              key: 'operational_costs',
            },
          ],
        },
        {
          href: '/dashboard/policy',
          label: 'Ph√¢n quy·ªÅn',
          active: pathname.includes('/policy'),
          icon: Settings,
          key: 'policy',
          submenus: [
            {
              href: '/dashboard/policy',
              label: 'Quy·ªÅn ch·ª©c nƒÉng',
              active: pathname === '/dashboard/policy',
              key: 'policy_list',
            },
            {
              href: '/dashboard/assign-policy',
              label: 'Ph√¢n quy·ªÅn',
              active: pathname === '/dashboard/assign-policy',
              key: 'assign_policy',
            },
          ],
        },
      ],
    },
  ];
};

export function getMenuListEmployee(pathname: string, poly_key: string[]): Group[] {
  console.log('üöÄ ~ getMenuListEmployee ~ pathname:', pathname);
  console.log('üöÄ ~ getMenuListEmployee ~ poly_key:', poly_key);
  if (poly_key.length === 0) {
    console.warn('No permissions found in poly_key. Returning empty menu.');
    return [];
  }

  const filteredMenuList: Group[] = baseMenuList(pathname)
    .map((group: Group) => {
      const filteredMenus = group.menus
        .map((menu: Menu) => {
          const filteredSubmenus = menu.submenus.filter((submenu: Submenu) => {
            const hasAccess = hasPermissionForPath(submenu.href, submenu.key, poly_key, permissions);
            console.log(`üöÄ ~ Checking submenu: ${submenu.href} (key: ${submenu.key}), hasAccess: ${hasAccess}`);
            return hasAccess;
          });
          const menuHasAccess = hasPermissionForPath(menu.href, menu.key, poly_key, permissions);
          console.log(`üöÄ ~ Checking menu: ${menu.href} (key: ${menu.key}), hasAccess: ${menuHasAccess}, submenus: ${filteredSubmenus.length}`);
          return {
            ...menu,
            submenus: filteredSubmenus,
          };
        })
        .filter((menu: Menu) => menu.submenus.length > 0 || hasPermissionForPath(menu.href, menu.key, poly_key, permissions));
      return {
        ...group,
        menus: filteredMenus,
      };
    })
    .filter((group: Group) => {
      console.log(`üöÄ ~ Group: ${group.groupLabel}, menus: ${group.menus.length}`);
      return group.menus.length > 0;
    });

  console.log(
    'üöÄ ~ getMenuListEmployee ~ filteredMenuList:',
    JSON.stringify(
      filteredMenuList.map((group: Group) => ({
        ...group,
        menus: group.menus.map((menu: Menu) => ({
          ...menu,
          icon: undefined, // Skip icon in log
        })),
      })),
      null,
      2
    )
  );
  return filteredMenuList;
}

export function getMenuListRestaurant(pathname: string): Group[] {
  return baseMenuList(pathname);
}